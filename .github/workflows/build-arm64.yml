name: Build and Publish vlsi-toolbox (ARM64)

on:
  push:
    branches:
      - '**'
  release:
    types: [created]
  workflow_dispatch:

jobs:
  build-and-push-arm64:
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Determine tags
      id: tags
      run: |
        REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
        BASE_IMAGE="ghcr.io/${REPO_OWNER_LOWER}/vlsi-toolbox"
        
        # Always include commit SHA tag
        TAGS="${BASE_IMAGE}:${{ github.sha }}-arm64"
        
        # Add release tag if this is a release event
        if [[ "${{ github.event_name }}" == "release" ]]; then
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          TAGS="${TAGS},${BASE_IMAGE}:${RELEASE_TAG}-arm64"
          TAGS="${TAGS},${BASE_IMAGE}:latest-arm64"
        fi
        
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
        echo "base_image=${BASE_IMAGE}" >> $GITHUB_OUTPUT

    - name: Build and push ARM64 image
      uses: docker/build-push-action@v4
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/arm64
        push: true
        tags: ${{ steps.tags.outputs.tags }}
        cache-from: type=registry,ref=${{ steps.tags.outputs.base_image }}:buildcache-arm64
        cache-to: type=registry,ref=${{ steps.tags.outputs.base_image }}:buildcache-arm64,mode=max

    - name: Image digest
      run: |
        echo "ARM64 Image pushed with tags: ${{ steps.tags.outputs.tags }}"
        docker buildx imagetools inspect ${{ steps.tags.outputs.base_image }}:${{ github.sha }}-arm64